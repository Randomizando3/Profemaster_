<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="ProfeMaster.Pages.PlansPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    BackgroundColor="#FFFFFF"
    Title=""
    Shell.NavBarIsVisible="False">

    <ContentPage.Resources>
        <Color x:Key="PmText">#2B2B2B</Color>
        <Color x:Key="PmMuted">#7B7B7B</Color>
        <Color x:Key="PmStroke">#E6E6E6</Color>
    </ContentPage.Resources>

    <Grid Padding="18" RowSpacing="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- TOP BAR (sem X) -->
        <Grid Grid.Row="0"
              ColumnDefinitions="*,Auto,Auto"
              ColumnSpacing="10">

            <VerticalStackLayout Grid.Column="0"
                                 Spacing="2"
                                 VerticalOptions="Center">
                <Label Text="Planos de Aula"
                       FontAttributes="Bold"
                       FontSize="14"
                       TextColor="{StaticResource PmText}" />
                <Label x:Name="SubLabel"
                       Text="Geral (todos)"
                       FontSize="12"
                       TextColor="{StaticResource PmMuted}"
                       LineBreakMode="TailTruncation"
                       MaxLines="1"/>
            </VerticalStackLayout>

            <Button Grid.Column="1"
                    Text="Atualizar"
                    HeightRequest="40"
                    Padding="14,0"
                    CornerRadius="16"
                    BackgroundColor="#F2F2F2"
                    TextColor="{StaticResource PmText}"
                    FontAttributes="Bold"
                    FontSize="12"
                    Clicked="OnRefreshClicked" />

            <Border Grid.Column="2"
                    StrokeThickness="0"
                    StrokeShape="RoundRectangle 16"
                    HeightRequest="40"
                    VerticalOptions="Center">
                <Border.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                        <GradientStop Color="#6A4FF0" Offset="0" />
                        <GradientStop Color="#9B7BFF" Offset="1" />
                    </LinearGradientBrush>
                </Border.Background>

                <Button Text="+ Novo"
                        HeightRequest="40"
                        Padding="14,0"
                        CornerRadius="16"
                        BackgroundColor="Transparent"
                        TextColor="#FFFFFF"
                        FontAttributes="Bold"
                        FontSize="12"
                        Clicked="OnAddClicked" />
            </Border>
        </Grid>

        <!-- SELETOR (igual Agenda) + PICKERS -->
        <Border Grid.Row="1"
                BackgroundColor="#FFFFFF"
                Stroke="#2B2B2B"
                StrokeThickness="1"
                StrokeShape="RoundRectangle 18"
                Padding="6">

            <VerticalStackLayout Spacing="10">

                <!-- Segmented -->
                <Grid x:Name="SegRoot"
                      ColumnDefinitions="*,*"
                      ColumnSpacing="6"
                      HeightRequest="42"
                      SizeChanged="OnSegRootSizeChanged">

                    <!-- highlight (por baixo dos botões) -->
                    <Border x:Name="SegHighlight"
                            Grid.Column="0"
                            StrokeThickness="0"
                            StrokeShape="RoundRectangle 14"
                            HeightRequest="42"
                            HorizontalOptions="Start"
                            VerticalOptions="Center"
                            TranslationX="0"
                            InputTransparent="True"
                            ZIndex="0">
                        <Border.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                <GradientStop Color="#B66AF4" Offset="0" />
                                <GradientStop Color="#7E97D9" Offset="1" />
                            </LinearGradientBrush>
                        </Border.Background>
                    </Border>

                    <Button x:Name="BtnAll"
                            Grid.Column="0"
                            Text="Geral"
                            Clicked="OnModeAllClicked"
                            BackgroundColor="Transparent"
                            CornerRadius="14"
                            HeightRequest="42"
                            FontAttributes="Bold"
                            FontSize="13"
                            TextColor="#FFFFFF"
                            Padding="0"
                            ZIndex="1"/>

                    <Button x:Name="BtnClass"
                            Grid.Column="1"
                            Text="Por turma"
                            Clicked="OnModeClassClicked"
                            BackgroundColor="Transparent"
                            CornerRadius="14"
                            HeightRequest="42"
                            FontAttributes="Bold"
                            FontSize="13"
                            TextColor="#6B6B6B"
                            Padding="0"
                            ZIndex="1"/>
                </Grid>

                <!-- Pickers custom (campo visível + overlay clicável) -->
                <Grid x:Name="PickersBox"
                      IsVisible="False"
                      ColumnDefinitions="*,*"
                      ColumnSpacing="10"
                      Margin="0,0,0,2">

                    <!-- Instituição -->
                    <Border BackgroundColor="#FFFFFF"
                            Stroke="{StaticResource PmStroke}"
                            StrokeThickness="2"
                            StrokeShape="RoundRectangle 16"
                            Padding="12,10">

                        <Grid ColumnDefinitions="*,Auto"
                              RowDefinitions="Auto,Auto"
                              VerticalOptions="Center">

                            <Label Text="Instituição"
                                   FontSize="10"
                                   TextColor="{StaticResource PmMuted}"
                                   Margin="0,0,0,2"/>

                            <Label Grid.Row="1"
                                   Text="{Binding Source={x:Reference InstitutionPicker}, Path=SelectedItem}"
                                   FontSize="12"
                                   TextColor="{StaticResource PmText}"
                                   LineBreakMode="TailTruncation"
                                   MaxLines="1" />

                            <Label Grid.Column="1"
                                   Grid.RowSpan="2"
                                   Text="▾"
                                   FontSize="16"
                                   TextColor="{StaticResource PmMuted}"
                                   VerticalOptions="Center"
                                   Margin="8,0,0,0"/>

                            <Picker x:Name="InstitutionPicker"
                                    Grid.RowSpan="2"
                                    Grid.ColumnSpan="2"
                                    Title="Instituição"
                                    SelectedIndexChanged="OnInstitutionChanged"
                                    Opacity="0.02"
                                    BackgroundColor="#FFFFFF"
                                    TextColor="{StaticResource PmText}" />
                        </Grid>
                    </Border>

                    <!-- Turma -->
                    <Border Grid.Column="1"
                            BackgroundColor="#FFFFFF"
                            Stroke="{StaticResource PmStroke}"
                            StrokeThickness="2"
                            StrokeShape="RoundRectangle 16"
                            Padding="12,10">

                        <Grid ColumnDefinitions="*,Auto"
                              RowDefinitions="Auto,Auto"
                              VerticalOptions="Center">

                            <Label Text="Turma"
                                   FontSize="10"
                                   TextColor="{StaticResource PmMuted}"
                                   Margin="0,0,0,2"/>

                            <Label Grid.Row="1"
                                   Text="{Binding Source={x:Reference ClassPicker}, Path=SelectedItem}"
                                   FontSize="12"
                                   TextColor="{StaticResource PmText}"
                                   LineBreakMode="TailTruncation"
                                   MaxLines="1" />

                            <Label Grid.Column="1"
                                   Grid.RowSpan="2"
                                   Text="▾"
                                   FontSize="16"
                                   TextColor="{StaticResource PmMuted}"
                                   VerticalOptions="Center"
                                   Margin="8,0,0,0"/>

                            <Picker x:Name="ClassPicker"
                                    Grid.RowSpan="2"
                                    Grid.ColumnSpan="2"
                                    Title="Turma"
                                    SelectedIndexChanged="OnClassChanged"
                                    Opacity="0.02"
                                    BackgroundColor="#FFFFFF"
                                    TextColor="{StaticResource PmText}" />
                        </Grid>
                    </Border>

                </Grid>

            </VerticalStackLayout>
        </Border>

        <!-- LISTA -->
        <CollectionView Grid.Row="2"
                        ItemsSource="{Binding Items}"
                        SelectionMode="Single"
                        SelectionChanged="OnSelected"
                        Margin="0,2,0,0">

            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Border Margin="0,0,0,12"
                            BackgroundColor="#FFFFFF"
                            Stroke="#E5E7EB"
                            StrokeThickness="2"
                            StrokeShape="RoundRectangle 18">

                        <Grid Padding="12"
                              ColumnDefinitions="Auto,*,Auto"
                              ColumnSpacing="12">

                            <!-- Thumb -->
                            <Border WidthRequest="56"
                                    HeightRequest="56"
                                    StrokeThickness="0"
                                    StrokeShape="RoundRectangle 14"
                                    BackgroundColor="#0F172A">
                                <Image Aspect="AspectFill"
                                       Source="{Binding ThumbSource}" />
                            </Border>

                            <!-- Infos -->
                            <VerticalStackLayout Grid.Column="1"
                                                 Spacing="3"
                                                 VerticalOptions="Center">

                                <Label Text="{Binding Title}"
                                       FontAttributes="Bold"
                                       FontSize="14"
                                       TextColor="{StaticResource PmText}"
                                       LineBreakMode="TailTruncation"
                                       MaxLines="1"/>

                                <Label Text="{Binding IntervalText}"
                                       TextColor="{StaticResource PmMuted}"
                                       FontSize="12"
                                       LineBreakMode="TailTruncation"
                                       MaxLines="1"/>

                                <Label Text="{Binding SlotsText}"
                                       TextColor="{StaticResource PmMuted}"
                                       FontSize="12"
                                       LineBreakMode="TailTruncation"
                                       MaxLines="1"/>

                                <Label Text="{Binding LinkedLessonsText}"
                                       TextColor="#9CA3AF"
                                       FontSize="12"
                                       LineBreakMode="TailTruncation"
                                       MaxLines="1"/>
                            </VerticalStackLayout>

                            <!-- Ações -->
                            <Grid Grid.Column="2"
                                  RowDefinitions="Auto,Auto"
                                  RowSpacing="8"
                                  VerticalOptions="Center"
                                  HorizontalOptions="End">

                                <Button Grid.Row="0"
                                        Text="✏️"
                                        HeightRequest="36"
                                        WidthRequest="44"
                                        Padding="0"
                                        CornerRadius="12"
                                        BackgroundColor="#F2F2F2"
                                        TextColor="{StaticResource PmText}"
                                        FontSize="14"
                                        Clicked="OnEditClicked"/>

                                <Button Grid.Row="1"
                                        Text="X"
                                        HeightRequest="36"
                                        WidthRequest="44"
                                        Padding="0"
                                        CornerRadius="12"
                                        BackgroundColor="#FF0000"
                                        TextColor="#FFFFFF"
                                        FontAttributes="Bold"
                                        FontSize="12"
                                        Clicked="OnDeleteClicked"/>
                            </Grid>

                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>

        </CollectionView>

    </Grid>
</ContentPage>
